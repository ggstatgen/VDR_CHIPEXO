#!/usr/bin/perl
use strict;
use warnings;
use File::Basename;
use Getopt::Long;
use IO::Zlib;

#basically just to automate the process of intersecting the VDR-BV SNPs annotated using funseq with the disease LD blocks for GWAS and GRASP
#inputs
#LD block beds with disease info
#VCFs for ASB interesting het snps coming from the allelespecific pipeline

#LD DISEASE INTERVALS
#my $INPUT_GWAS_CEU  = "/net/isi-scratch/giuseppe/indexes/GWAS/LD_PLINK_CEU_GWAScat_p_5x10-8_min5SNP.vcf.gz";
#my $INPUT_GWAS_YRI  = "/net/isi-scratch/giuseppe/indexes/GWAS/LD_PLINK_YRI_GWAScat_p_5x10-8_min5SNP.vcf.gz";
my $INPUT_GWAS_CEU = "/net/isi-scratch/giuseppe/indexes/GWAS/UCSC_gwas_catalog/LD_PLINK_CEU_GWAScat.bed.gz";
my $INPUT_GWAS_YRI = "/net/isi-scratch/giuseppe/indexes/GWAS/UCSC_gwas_catalog/LD_PLINK_YRI_GWAScat.bed.gz";

#my $INPUT_GRASP_CEU = "/net/isi-scratch/giuseppe/indexes/GWAS/GRASP/LD_PLINK_CEU_GRASP2final.vcf.gz";
#my $INPUT_GRASP_YRI = "/net/isi-scratch/giuseppe/indexes/GWAS/GRASP/LD_PLINK_YRI_GRASP2final.vcf.gz";

my $input_all       = "/net/isi-scratch/giuseppe/tools/funseq2-1.0/out_allsamples_plus_qtl_ancestral/GWAS_INTERSECTIONS/Output_b37.vcf";
my $input_vdr       = "/net/isi-scratch/giuseppe/tools/funseq2-1.0/out_allsamples_plus_qtl_ancestral/GWAS_INTERSECTIONS/Output_invdrpeaks_b37.vcf";
my $input_recur     = "/net/isi-scratch/giuseppe/tools/funseq2-1.0/out_allsamples_plus_qtl_ancestral/GWAS_INTERSECTIONS/Output_recur_b37.vcf";
my $input_vdr_recur = "/net/isi-scratch/giuseppe/tools/funseq2-1.0/out_allsamples_plus_qtl_ancestral/GWAS_INTERSECTIONS/Output_recur_invdrpeaks_b37.vcf";

my ($filename,  $directory) = fileparse($input_all);
my $BEDTOOLS = "/net/isi-scratch/giuseppe/tools/bedtools-2.22.1/bin/bedtools";

#GRASP data header:
#my $header_grasp = "CHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249";

#GWAScatalog header:
my $header_gwas = "CHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249";

print STDERR "do_funseq_intersect_PLINK_LD:\n";
print STDERR "Using the following files:\n";
print STDERR "gwas LD blocks CEU: $INPUT_GWAS_CEU\n";
print STDERR "gwas LD blocks YRI: $INPUT_GWAS_YRI\n";
#print STDERR "GRASP LD blocks CEU: $INPUT_GRASP_CEU\n";
#print STDERR "GRASP LD blocks YRI: $INPUT_GRASP_YRI\n";
print STDERR "Processing overlap files under $directory\n";
print STDERR "Saving all output under $directory\n";
print STDERR "edit if required\n";

my $out_all_GWAS_CEU  = $directory . "LD_PLINK_CEU_GWAScat_all.tsv";
my $out_all_GWAS_YRI  = $directory . "LD_PLINK_YRI_GWAScat_all.tsv";
#my $out_all_GRASP_CEU = $directory . "LD_PLINK_CEU_GRASP_all.tsv";
#my $out_all_GRASP_YRI = $directory . "LD_PLINK_YRI_GRASP_all.tsv";

my $out_vdr_GWAS_CEU  = $directory . "LD_PLINK_CEU_GWAScat_vdr.tsv";
my $out_vdr_GWAS_YRI  = $directory . "LD_PLINK_YRI_GWAScat_vdr.tsv";
#my $out_vdr_GRASP_CEU = $directory . "LD_PLINK_CEU_GRASP_vdr.tsv";
#my $out_vdr_GRASP_YRI = $directory . "LD_PLINK_YRI_GRASP_vdr.tsv";

my $out_recur_GWAS_CEU  = $directory . "LD_PLINK_CEU_GWAScat_recur.tsv";
my $out_recur_GWAS_YRI  = $directory . "LD_PLINK_YRI_GWAScat_recur.tsv";
#my $out_recur_GRASP_CEU = $directory . "LD_PLINK_CEU_GRASP_recur.tsv";
#my $out_recur_GRASP_YRI = $directory . "LD_PLINK_YRI_GRASP_recur.tsv";

my $out_vdrrecur_GWAS_CEU  = $directory . "LD_PLINK_CEU_GWAScat_vdrrecur.tsv";
my $out_vdrrecur_GWAS_YRI  = $directory . "LD_PLINK_YRI_GWAScat_vdrrecur.tsv";
#my $out_vdrrecur_GRASP_CEU = $directory . "LD_PLINK_CEU_GRASP_vdrrecur.tsv";
#my $out_vdrrecur_GRASP_YRI = $directory . "LD_PLINK_YRI_GRASP_vdrrecur.tsv";

#bedtools intersect -wo -a LD_PLINK_[CEU|YRI]_GRASP2final.vcf.gz -b interestingHets_consensus_inpeaks_o[1,2,3,4,5,6].vcf.gz > o[1,2,3,4,5,6]_LD_PLINK_[CEU|YRI]_GRASP2final.tsv


system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_CEU  -b $input_all  > $out_all_GWAS_CEU";
system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_YRI  -b $input_all  > $out_all_GWAS_YRI";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_CEU -b $input_all  > $out_all_GRASP_CEU";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_YRI -b $input_all  > $out_all_GRASP_YRI";

system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_CEU  -b $input_vdr  > $out_vdr_GWAS_CEU";
system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_YRI  -b $input_vdr  > $out_vdr_GWAS_YRI";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_CEU -b $input_vdr  > $out_vdr_GRASP_CEU";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_YRI -b $input_vdr  > $out_vdr_GRASP_YRI";

system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_CEU  -b $input_recur  > $out_recur_GWAS_CEU";
system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_YRI  -b $input_recur  > $out_recur_GWAS_YRI";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_CEU -b $input_recur  > $out_recur_GRASP_CEU";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_YRI -b $input_recur  > $out_recur_GRASP_YRI";

system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_CEU  -b $input_vdr_recur  > $out_vdrrecur_GWAS_CEU";
system "$BEDTOOLS intersect -wo -a $INPUT_GWAS_YRI  -b $input_vdr_recur  > $out_vdrrecur_GWAS_YRI";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_CEU -b $input_vdr_recur  > $out_vdrrecur_GRASP_CEU";
#system "$BEDTOOLS intersect -wo -a $INPUT_GRASP_YRI -b $input_vdr_recur  > $out_vdrrecur_GRASP_YRI";

#HEADER
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_all_GRASP_CEU";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdr_GRASP_CEU";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_recur_GRASP_CEU";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdrrecur_GRASP_CEU";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_all_GRASP_YRI";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdr_GRASP_YRI";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_recur_GRASP_YRI";
#system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GRASP_CHR	GRASP_DISEASE_SNP_POS	GRASP_DISEASE_SNP_ID	REF	ALT	QUAL	GRASP_PHENOTYPE	GRASP_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdrrecur_GRASP_YRI";



system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_all_GWAS_CEU";
system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdr_GWAS_CEU";
system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_recur_GWAS_CEU";
system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdrrecur_GWAS_CEU";


system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_all_GWAS_YRI";
system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdr_GWAS_YRI";
system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_recur_GWAS_YRI";
system "sed -i '1iCHR	LD_START	LD_STOP	SNPS_IN_BLOCK	BLOCK_SIZE_KB	GWAS_CHR	GWAS_DISEASE_SNP_POS	GWAS_DISEASE_SNP_ID	REF	ALT	QUAL	GWAS_PHENOTYPE	GWAS_PH_CAT_PVAL	BEDTOOLS_INTERSECT	ASB_CHR	ASB_SNP_POS	ASB_SNP_ID	ASB_REF	ASB_ALT	ASB_QUAL	ASB_FILTER	ASB_1KG_INFO	ASB_1KG_FORMAT	NA06986	NA06989	NA10847	NA11829	NA11919	NA12383	NA12489	NA12872	NA19189	NA19190	NA19213	NA19235	NA19236	NA19247	NA19248	NA07029	NA10831	NA11832	NA19191	NA19249' $out_vdrrecur_GWAS_CEU";
;

print STDERR "FINISHED.\n";
